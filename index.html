<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kh125's Japanese Study Tools</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script type="module" src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background color (similar to GitHub dark) */
            color: #c9d1d9; /* Light text color */
            min-height: 100vh;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444c56; }

        /* Lucide icon setup */
        .icon { width: 20px; height: 20px; margin-right: 8px; }

        /* Dashboard-specific styles */
        .kanban-column { min-height: 200px; }
        .task { cursor: grab; touch-action: none; transition: all 0.2s; border-left: 4px solid transparent; }
        .task:active { cursor: grabbing; }
        .task.dragging { opacity: 0.5; }
        .task.priority { border-left-color: #f59e0b; background-color: #1f2937; } /* amber-500 */
        .task.done { opacity: 0.7; }
        .task.done p { text-decoration: line-through; }

        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #0ea5e9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .progress-control-btn {
            width: 32px; height: 32px; border-radius: 9999px; background-color: #374151;
            color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;
        }
        .progress-control-btn:hover { background-color: #4b5563; }
        .timer-mode-btn {
            background-color: transparent; border: 1px solid #4b5563; color: #9ca3af;
        }
        .timer-mode-btn.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        
        #history-modal summary { cursor: pointer; outline: none; }
        #history-modal details[open] summary { margin-bottom: 0.5rem; }
        .task-actions { opacity: 0; transition: opacity 0.2s; }
        .task:hover .task-actions { opacity: 1; }

        /* Date input styling for dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        /* Details/Summary accordion styling */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary::after {
            content: ' ‚ñº';
            font-size: 0.8em;
        }
        details[open] > summary::after {
            content: ' ‚ñ≤';
        }

    </style>
</head>
<body class="antialiased">

    <div class="max-w-7xl mx-auto p-4 sm:p-8">

        <!-- Productivity Hub Section -->
        <section id="productivity-hub" class="mb-16">
             <header class="mb-8 text-center pt-12">
                <h2 class="text-4xl font-bold tracking-tight gradient-text">Personal Dashboard</h2>
                <p class="text-slate-400 mt-1">Your private command center for development and language learning. Data is saved locally.</p>
            </header>
            
            <!-- Full-width Countdown -->
            <div class="bg-[#161b22] rounded-xl p-8 ring-1 ring-white/10 text-center mb-8">
                <h3 class="text-2xl font-medium text-sky-300">JLPT N4 Exam Countdown</h3>
                <div id="countdown" class="text-8xl font-bold text-indigo-400 my-4">...</div>
                <p class="text-md text-slate-400">Until December 7, 2025</p>
            </div>

            <!-- N4 Progress & Stats Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                 <!-- N4 Progress Card -->
                <div class="bg-[#161b22] rounded-xl p-6 ring-1 ring-white/10">
                    <h3 class="text-xl font-semibold mb-4 text-sky-300">üéå N4 Progress</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Lesson Progress -->
                        <div>
                            <label class="block text-lg font-medium mb-2">Lesson Progress</label>
                            <div class="w-full bg-slate-700 rounded-full h-2.5 mb-3">
                                <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-sky-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-400">L1</span>
                                <div class="flex items-center gap-3">
                                    <button id="lesson-minus" class="progress-control-btn">-</button>
                                    <span id="lesson-count" class="text-xl font-bold w-12 text-center">0</span>
                                    <button id="lesson-plus" class="progress-control-btn">+</button>
                                </div>
                                <span class="text-sm text-slate-400">L50</span>
                            </div>
                        </div>
                        <!-- Kanji Progress -->
                        <div>
                            <label class="block text-lg font-medium mb-2">Kanji Progress</label>
                            <div class="w-full bg-slate-700 rounded-full h-2.5 mb-3">
                                <div id="kanji-progress-bar" class="bg-gradient-to-r from-indigo-500 to-sky-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-400">0</span>
                                <div class="flex items-center gap-3">
                                    <button id="kanji-minus" class="progress-control-btn">-</button>
                                    <span id="kanji-count" class="text-xl font-bold w-12 text-center">0</span>
                                    <button id="kanji-plus" class="progress-control-btn">+</button>
                                </div>
                                <span class="text-sm text-slate-400">200</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timers & Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                     <!-- Pomodoro Timer -->
                     <div class="bg-[#161b22] rounded-xl p-6 ring-1 ring-white/10 text-center flex flex-col justify-center">
                         <h3 class="text-xl font-semibold mb-4 text-sky-300">üçÖ Pomodoro Timer</h3>
                         <div id="pomodoro-timer" class="text-6xl font-bold text-indigo-400">25:00</div>
                         <div class="flex justify-center gap-2 my-4">
                             <button id="pomo-mode-pomodoro" class="timer-mode-btn active px-3 py-1 rounded-md text-sm">Study</button>
                             <button id="pomo-mode-short" class="timer-mode-btn px-3 py-1 rounded-md text-sm">Short</button>
                             <button id="pomo-mode-long" class="timer-mode-btn px-3 py-1 rounded-md text-sm">Long</button>
                         </div>
                         <div class="flex justify-center gap-4">
                            <button id="pomo-start-pause" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-6 rounded-lg transition-colors">Start</button>
                            <button id="pomo-reset" class="bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-6 rounded-lg transition-colors">Reset</button>
                         </div>
                     </div>
                    <!-- Study Streak -->
                     <div class="bg-[#161b22] rounded-xl p-6 ring-1 ring-white/10 text-center flex flex-col justify-center">
                         <h3 class="text-xl font-semibold mb-4 text-sky-300">üî• Study Streak</h3>
                         <div class="flex items-center justify-center">
                             <span id="streak-count" class="text-6xl font-bold text-indigo-400">0</span>
                             <span class="ml-3 text-lg text-slate-400">days</span>
                         </div>
                         <p id="last-streak-date" class="text-xs text-slate-500 mt-2">No activity yet.</p>
                     </div>
                </div>
            </div>

            <!-- Unified Task Board -->
            <section id="mission-control" class="bg-[#161b22] rounded-xl p-6 ring-1 ring-white/10 mb-8">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold gradient-text">Mission Control</h2>
                    <button id="create-task-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-5 rounded-lg transition-colors flex items-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add Task
                    </button>
                 </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div>
                        <h4 class="font-semibold text-center mb-4 pb-2 border-b-2 border-red-400 flex justify-center items-center gap-2">To Do <span id="todo-count" class="text-xs bg-red-400/50 text-white rounded-full px-2 py-0.5">0</span></h4>
                        <div id="todo-column" class="kanban-column space-y-3 p-2 bg-slate-900/50 rounded-lg"></div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-center mb-4 pb-2 border-b-2 border-yellow-400 flex justify-center items-center gap-2">In Progress <span id="inprogress-count" class="text-xs bg-yellow-400/50 text-white rounded-full px-2 py-0.5">0</span></h4>
                        <div id="inprogress-column" class="kanban-column space-y-3 p-2 bg-slate-900/50 rounded-lg"></div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-center mb-4 pb-2 border-b-2 border-green-400 flex justify-center items-center gap-2">Done <span id="done-count" class="text-xs bg-green-400/50 text-white rounded-full px-2 py-0.5">0</span></h4>
                        <div id="done-column" class="kanban-column space-y-3 p-2 bg-slate-900/50 rounded-lg"></div>
                    </div>
                </div>
            </section>
            
             <!-- Simplified Weekly Review Section -->
            <section id="weekly-review" class="bg-[#161b22] rounded-xl p-6 ring-1 ring-white/10 mb-8">
                <details>
                    <summary class="flex justify-between items-center cursor-pointer">
                        <h2 class="text-2xl font-bold gradient-text">Weekly Review</h2>
                        <button id="view-history-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm flex items-center">
                            <i data-lucide="history" class="w-4 h-4 mr-2"></i>View History
                        </button>
                    </summary>
                    <div class="bg-slate-800/50 p-4 rounded-lg mt-4">
                        <h3 class="text-lg font-semibold mb-3 text-sky-300 flex items-center"><i data-lucide="award" class="icon text-sky-300"></i>Last Week's Wins</h3>
                        <ul id="wins-list" class="list-disc list-inside text-sm text-slate-300 space-y-1 mb-4"><li>Nothing yet.</li></ul>
                        <button id="archive-tasks-btn" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm flex items-center justify-center">
                            <i data-lucide="archive" class="w-4 h-4 mr-2"></i>Clear Completed Tasks
                        </button>
                    </div>
                </details>
            </section>

        </section>

        <!-- Application Cards Grid -->
        <section id="public-projects">
            <header class="mb-8 text-center">
                <h2 class="text-3xl font-bold text-gray-300">Public Study Tools</h2>
                 <p class="text-slate-400 mt-1">My open-source projects for Japanese learners.</p>
            </header>
            <div id="app-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </section>

        <!-- Footer -->
        <footer class="text-center pt-16 pb-8 text-gray-500 text-sm">
            <p>&copy; 2024 kh125. All Rights Reserved. | Hosted via GitHub Pages.</p>
        </footer>
    </div>

    <!-- Task Create/Edit Modal -->
    <div id="task-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-[#161b22] w-full max-w-lg rounded-xl ring-1 ring-white/10 flex flex-col">
            <header class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h2 id="task-modal-title" class="text-xl font-bold gradient-text">Add Task</h2>
                <button id="close-task-modal-btn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </header>
            <form id="task-form" class="p-6 space-y-4">
                <input type="hidden" id="task-id-input">
                <div>
                    <label for="task-text-input" class="block text-sm font-medium text-slate-300 mb-1">Task Description</label>
                    <input type="text" id="task-text-input" class="w-full bg-slate-700 rounded-md border-slate-600 p-2 placeholder:text-slate-400" required>
                </div>
                <div>
                    <label for="task-date-input" class="block text-sm font-medium text-slate-300 mb-1">Due Date</label>
                    <input type="date" id="task-date-input" class="w-full bg-slate-700 rounded-md border-slate-600 p-2 text-slate-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Type</label>
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-2"><input type="radio" name="modal-task-type" value="dev" class="form-radio bg-slate-600 border-slate-500 text-sky-500 focus:ring-sky-500" checked><span class="text-sky-300 font-medium">Dev</span></label>
                        <label class="flex items-center gap-2"><input type="radio" name="modal-task-type" value="learning" class="form-radio bg-slate-600 border-slate-500 text-indigo-500 focus:ring-indigo-500"><span class="text-indigo-300 font-medium">Learn</span></label>
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-task-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-5 rounded-lg transition-colors">Cancel</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-5 rounded-lg transition-colors">Save Task</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Task History Modal -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-[#161b22] w-full max-w-2xl max-h-[90vh] rounded-xl ring-1 ring-white/10 flex flex-col">
            <header class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold gradient-text">Completed Task History</h2>
                <button id="close-history-btn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </header>
            <div id="history-content" class="p-6 overflow-y-auto space-y-4"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const STORAGE_KEY = 'productivityHubData_v2';
            
            // --- Elements ---
            const countdownEl = document.getElementById('countdown');
            const progressBarEl = document.getElementById('progress-bar');
            const kanjiProgressBarEl = document.getElementById('kanji-progress-bar');
            const lessonCountEl = document.getElementById('lesson-count');
            const kanjiCountEl = document.getElementById('kanji-count');
            const lessonPlusBtn = document.getElementById('lesson-plus');
            const lessonMinusBtn = document.getElementById('lesson-minus');
            const kanjiPlusBtn = document.getElementById('kanji-plus');
            const kanjiMinusBtn = document.getElementById('kanji-minus');

            // Unified Task Board Elements
            const createTaskBtn = document.getElementById('create-task-btn');
            const taskColumns = { todo: document.getElementById('todo-column'), inprogress: document.getElementById('inprogress-column'), done: document.getElementById('done-column') };
            const taskCounters = { todo: document.getElementById('todo-count'), inprogress: document.getElementById('inprogress-count'), done: document.getElementById('done-count') };
            
            // Task Modal Elements
            const taskModal = document.getElementById('task-modal');
            const taskModalTitle = document.getElementById('task-modal-title');
            const closeTaskModalBtn = document.getElementById('close-task-modal-btn');
            const cancelTaskBtn = document.getElementById('cancel-task-btn');
            const taskForm = document.getElementById('task-form');
            const taskIdInput = document.getElementById('task-id-input');
            const taskTextInput = document.getElementById('task-text-input');
            const taskDateInput = document.getElementById('task-date-input');

            const pomodoroTimerEl = document.getElementById('pomodoro-timer');
            const pomoStartPauseBtn = document.getElementById('pomo-start-pause');
            const pomoResetBtn = document.getElementById('pomo-reset');
            const pomoModeButtons = { pomodoro: document.getElementById('pomo-mode-pomodoro'), short: document.getElementById('pomo-mode-short'), long: document.getElementById('pomo-mode-long') };
            const streakCountEl = document.getElementById('streak-count');
            const lastStreakDateEl = document.getElementById('last-streak-date');
            
            const winsListEl = document.getElementById('wins-list');
            const archiveTasksBtn = document.getElementById('archive-tasks-btn');

            const historyModal = document.getElementById('history-modal');
            const viewHistoryBtn = document.getElementById('view-history-btn');
            const closeHistoryBtn = document.getElementById('close-history-btn');
            const historyContentEl = document.getElementById('history-content');

            // --- Data & State ---
            let data = {
                tasks: [],
                currentLesson: 1,
                kanjiLearned: 0,
                studyStreak: { current: 0, lastUpdate: null },
                tasksArchive: []
            };

            let pomoState = { timerId: null, mode: 'pomodoro', timeRemaining: 1500, isRunning: false, times: { pomodoro: 1500, short: 300, long: 900 } };
            
            // --- Data Persistence ---
            const saveData = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            const loadData = () => {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    data = JSON.parse(savedData);
                    if (!data.tasks) data.tasks = [];
                    if (data.kanjiLearned === undefined) data.kanjiLearned = 0;
                    if (data.currentLesson === undefined) data.currentLesson = 1;
                    if (!data.studyStreak) data.studyStreak = { current: 0, lastUpdate: null };
                    if (!data.tasksArchive) data.tasksArchive = [];
                }
            };
            
            // --- Core Functions ---
            const getTodayDateString = () => new Date().toISOString().split('T')[0];
            const calculateCountdown = () => {
                if(!countdownEl) return;
                const examDate = new Date('2025-12-07T00:00:00');
                const diffDays = Math.ceil((examDate - new Date()) / (1000 * 60 * 60 * 24));
                countdownEl.textContent = `${diffDays} days`;
            };

            const updateLessonProgressBar = () => {
                if(!progressBarEl || !lessonCountEl) return;
                const percentage = ((data.currentLesson - 1) / 49) * 100;
                progressBarEl.style.width = `${percentage}%`;
                lessonCountEl.textContent = data.currentLesson;
            };
            const updateKanjiProgressBar = () => {
                if(!kanjiProgressBarEl || !kanjiCountEl) return;
                const percentage = (data.kanjiLearned / 200) * 100;
                kanjiProgressBarEl.style.width = `${percentage}%`;
                kanjiCountEl.textContent = data.kanjiLearned;
            };
            const updateStudyStreak = () => {
                const today = getTodayDateString();
                if (data.studyStreak.lastUpdate === today) return;
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                if (data.studyStreak.lastUpdate === yesterdayStr) {
                    data.studyStreak.current += 1;
                } else {
                    data.studyStreak.current = 1;
                }
                data.studyStreak.lastUpdate = today;
                saveData();
                renderStudyStreak();
            };
            const renderStudyStreak = () => {
                if (!streakCountEl) return;
                const today = getTodayDateString();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                if (data.studyStreak.lastUpdate && data.studyStreak.lastUpdate < yesterdayStr) {
                    data.studyStreak.current = 0;
                    saveData();
                }
                streakCountEl.textContent = data.studyStreak.current;
                lastStreakDateEl.textContent = data.studyStreak.lastUpdate ? `Last activity: ${data.studyStreak.lastUpdate}` : 'No activity yet.';
            };
            const playSound = () => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                oscillator.connect(audioContext.destination);
                oscillator.start();
                setTimeout(() => oscillator.stop(), 500);
            };
            const updatePomoDisplay = () => {
                if (!pomodoroTimerEl) return;
                const minutes = Math.floor(pomoState.timeRemaining / 60);
                const seconds = pomoState.timeRemaining % 60;
                pomodoroTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };
            const startPomoTimer = () => {
                if (pomoState.isRunning || !pomoStartPauseBtn) return;
                pomoState.isRunning = true;
                pomoStartPauseBtn.textContent = 'Pause';
                pomoState.timerId = setInterval(() => {
                    pomoState.timeRemaining--;
                    updatePomoDisplay();
                    if (pomoState.timeRemaining <= 0) {
                        clearInterval(pomoState.timerId);
                        playSound();
                        if (pomoState.mode === 'pomodoro') updateStudyStreak();
                        pomoState.isRunning = false;
                        pomoStartPauseBtn.textContent = 'Start';
                    }
                }, 1000);
            };
            const pausePomoTimer = () => {
                clearInterval(pomoState.timerId);
                pomoState.isRunning = false;
                if(pomoStartPauseBtn) pomoStartPauseBtn.textContent = 'Start';
            };
            const switchPomoMode = (mode) => {
                pausePomoTimer();
                pomoState.mode = mode;
                pomoState.timeRemaining = pomoState.times[mode];
                Object.values(pomoModeButtons).forEach(btn => btn.classList.remove('active'));
                pomoModeButtons[mode].classList.add('active');
                updatePomoDisplay();
            };
            
            // --- Simplified Weekly Review ---
            const renderWeeklyReview = () => {
                if(!winsListEl) return;
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const recentWins = [...data.tasks, ...data.tasksArchive].filter(task => task.status === 'done' && task.completedDate && new Date(task.completedDate) > oneWeekAgo);
                
                if (recentWins.length > 0) {
                     winsListEl.innerHTML = recentWins.map(task => {
                        const typeLabel = task.type === 'dev' 
                            ? '<span class="text-xs font-semibold bg-sky-500/50 text-sky-200 px-2 py-0.5 rounded-full ml-2">Dev</span>' 
                            : '<span class="text-xs font-semibold bg-indigo-500/50 text-indigo-200 px-2 py-0.5 rounded-full ml-2">Learn</span>';
                        return `<li>${task.text} ${typeLabel}</li>`;
                     }).join('');
                } else {
                    winsListEl.innerHTML = `<li>No tasks completed in the last 7 days.</li>`;
                }
            };

            const handleArchiveTasks = () => {
                const completedToday = data.tasks.filter(t => t.status === 'done');
                data.tasksArchive.push(...completedToday);
                data.tasks = data.tasks.filter(t => t.status !== 'done');
                saveData();
                renderTasks();
                renderWeeklyReview();
            };

            // --- Task History Modal ---
            const openHistoryModal = () => { renderHistory(); historyModal.classList.remove('hidden'); };
            const closeHistoryModal = () => { historyModal.classList.add('hidden'); };
            const renderHistory = () => {
                const allDoneTasks = [...data.tasksArchive, ...data.tasks.filter(t => t.status === 'done')];
                const uniqueTasks = Array.from(new Map(allDoneTasks.map(task => [task.id, task])).values());
                const tasksByDay = uniqueTasks.reduce((acc, task) => {
                    if(!task.completedDate) return acc;
                    const date = new Date(task.completedDate).toISOString().split('T')[0];
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(task);
                    return acc;
                }, {});

                const sortedDays = Object.keys(tasksByDay).sort((a, b) => new Date(b) - new Date(a));
                if (sortedDays.length === 0) {
                    historyContentEl.innerHTML = '<p class="text-slate-500 text-center">No completed tasks yet.</p>'; return;
                }
                historyContentEl.innerHTML = sortedDays.map(day => {
                    const date = new Date(day);
                    const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const tasksHtml = tasksByDay[day].map(task => {
                        const typeLabel = task.type === 'dev' 
                            ? '<span class="text-xs font-semibold bg-sky-500/50 text-sky-200 px-2 py-0.5 rounded-full ml-2">Dev</span>' 
                            : '<span class="text-xs font-semibold bg-indigo-500/50 text-indigo-200 px-2 py-0.5 rounded-full ml-2">Learn</span>';
                        return `<li class="text-slate-300">${task.text} ${typeLabel}</li>`;
                    }).join('');
                    return `<details class="bg-slate-800/50 p-3 rounded-lg" open><summary class="font-semibold text-lg text-slate-200">${formattedDate}</summary><ul class="mt-2 pl-4 space-y-1 list-disc list-inside">${tasksHtml}</ul></details>`;
                }).join('');
            };
            
            // --- Task Modal ---
            const openTaskModal = (taskId = null) => {
                taskForm.reset();
                if (taskId) {
                    const task = data.tasks.find(t => t.id === taskId);
                    if (task) {
                        taskModalTitle.textContent = 'Edit Task';
                        taskIdInput.value = task.id;
                        taskTextInput.value = task.text;
                        taskDateInput.value = task.dueDate || '';
                        taskForm.querySelector(`input[name="modal-task-type"][value="${task.type}"]`).checked = true;
                    }
                } else {
                    taskModalTitle.textContent = 'Add Task';
                    taskIdInput.value = '';
                }
                taskModal.classList.remove('hidden');
            };
            const closeTaskModal = () => taskModal.classList.add('hidden');
            const handleTaskFormSubmit = (e) => {
                e.preventDefault();
                const id = taskIdInput.value;
                const text = taskTextInput.value.trim();
                const type = taskForm.querySelector('input[name="modal-task-type"]:checked').value;
                const dueDate = taskDateInput.value;

                if (!text) return;

                if (id) { // Editing existing task
                    const task = data.tasks.find(t => t.id === id);
                    if (task) {
                        task.text = text;
                        task.type = type;
                        task.dueDate = dueDate || null;
                    }
                } else { // Creating new task
                    data.tasks.push({ id: `task-${Date.now()}`, text, status: 'todo', type, priority: false, dueDate: dueDate || null });
                }
                saveData();
                renderTasks();
                closeTaskModal();
            };
            
            // --- Auto-archiving logic ---
            const archiveOldDoneTasks = () => {
                const todayStr = getTodayDateString();
                const tasksToArchive = data.tasks.filter(task => 
                    task.status === 'done' && 
                    task.completedDate && 
                    task.completedDate.split('T')[0] < todayStr
                );
                
                if (tasksToArchive.length > 0) {
                    data.tasksArchive.push(...tasksToArchive);
                    data.tasks = data.tasks.filter(task => !tasksToArchive.find(t => t.id === task.id));
                    saveData();
                }
            };


            // --- Unified Task Board Logic ---
            const createTaskElement = (task) => {
                const taskEl = document.createElement('div');
                const isDone = task.status === 'done';
                taskEl.className = `task bg-slate-700 p-3 rounded-lg shadow flex justify-between items-center ${task.priority ? 'priority' : ''} ${isDone ? 'done' : ''}`;
                taskEl.draggable = true;
                taskEl.dataset.id = task.id;

                const typeBadge = task.type === 'dev'
                    ? '<span class="text-xs font-semibold bg-sky-500/50 text-sky-200 px-2 py-1 rounded-full">Dev</span>'
                    : '<span class="text-xs font-semibold bg-indigo-500/50 text-indigo-200 px-2 py-1 rounded-full">Learn</span>';
                
                let dueDateHtml = '';
                if (task.dueDate) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const dueDate = new Date(task.dueDate);
                    const isOverdue = dueDate < today && task.status !== 'done';
                    const formattedDate = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    dueDateHtml = `
                        <div class="text-xs mt-2 flex items-center ${isOverdue ? 'text-red-400' : 'text-slate-400'}">
                            <i data-lucide="calendar" class="w-3 h-3 mr-1"></i>
                            <span>${formattedDate}</span>
                        </div>
                    `;
                }

                taskEl.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex items-center">
                            ${typeBadge}
                            <p class="ml-3 flex-1">${task.text}</p>
                        </div>
                        ${dueDateHtml}
                    </div>
                    <div class="task-actions flex-shrink-0 flex items-center ml-2">
                        <button class="priority-btn text-slate-400 hover:text-amber-400 p-1">${task.priority ? '‚òÖ' : '‚òÜ'}</button>
                        <button class="edit-btn text-slate-400 hover:text-sky-400 p-1"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button class="delete-btn text-slate-400 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
                
                taskEl.querySelector('.delete-btn').onclick = () => { data.tasks = data.tasks.filter(t => t.id !== task.id); saveData(); renderTasks(); };
                taskEl.querySelector('.priority-btn').onclick = () => { 
                    const targetTask = data.tasks.find(t => t.id === task.id);
                    if(targetTask) targetTask.priority = !targetTask.priority; 
                    saveData(); 
                    renderTasks(); 
                };
                taskEl.querySelector('.edit-btn').onclick = () => openTaskModal(task.id);
                
                taskEl.addEventListener('dragstart', (e) => { e.target.classList.add('dragging'); e.dataTransfer.setData('taskId', task.id); });
                taskEl.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                return taskEl;
            };

            const renderTasks = () => {
                Object.values(taskColumns).forEach(col => col.innerHTML = '');
                data.tasks.forEach(task => {
                    const taskEl = createTaskElement(task);
                    taskColumns[task.status]?.appendChild(taskEl);
                });
                updateTaskCounts();
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            };
            
            const updateTaskCounts = () => {
                 if(!taskCounters.todo) return;
                 taskCounters.todo.textContent = data.tasks.filter(t => t.status === 'todo').length;
                 taskCounters.inprogress.textContent = data.tasks.filter(t => t.status === 'inprogress').length;
                 taskCounters.done.textContent = data.tasks.filter(t => t.status === 'done').length;
            };

            const getDragAfterElement = (container, y) => {
                const draggableElements = [...container.querySelectorAll('.task:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } 
                    else { return closest; }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            };

            const initDashboard = () => {
                loadData();
                archiveOldDoneTasks(); // Run the new cleanup logic on load
                calculateCountdown();
                setInterval(calculateCountdown, 1000 * 60 * 60);
                
                // Render all components
                updateLessonProgressBar();
                updateKanjiProgressBar();
                renderStudyStreak();
                updatePomoDisplay();
                renderWeeklyReview();
                renderTasks();
                
                // --- Event Listeners ---
                lessonPlusBtn?.addEventListener('click', () => { if (data.currentLesson < 50) data.currentLesson++; updateLessonProgressBar(); saveData(); });
                lessonMinusBtn?.addEventListener('click', () => { if (data.currentLesson > 1) data.currentLesson--; updateLessonProgressBar(); saveData(); });
                kanjiPlusBtn?.addEventListener('click', () => { if (data.kanjiLearned < 200) data.kanjiLearned++; updateKanjiProgressBar(); saveData(); });
                kanjiMinusBtn?.addEventListener('click', () => { if (data.kanjiLearned > 0) data.kanjiLearned--; updateKanjiProgressBar(); saveData(); });

                pomoStartPauseBtn?.addEventListener('click', () => pomoState.isRunning ? pausePomoTimer() : startPomoTimer());
                pomoResetBtn?.addEventListener('click', () => switchPomoMode(pomoState.mode));
                Object.values(pomoModeButtons).forEach((btn, index) => {
                    const mode = Object.keys(pomoModeButtons)[index];
                    btn?.addEventListener('click', () => switchPomoMode(mode));
                });
                
                // Task Modal Listeners
                createTaskBtn?.addEventListener('click', () => openTaskModal());
                closeTaskModalBtn?.addEventListener('click', closeTaskModal);
                cancelTaskBtn?.addEventListener('click', closeTaskModal);
                taskModal?.addEventListener('click', (e) => { if (e.target === taskModal) closeTaskModal(); });
                taskForm?.addEventListener('submit', handleTaskFormSubmit);


                archiveTasksBtn?.addEventListener('click', handleArchiveTasks);
                viewHistoryBtn?.addEventListener('click', openHistoryModal);
                closeHistoryBtn?.addEventListener('click', closeHistoryModal);
                historyModal?.addEventListener('click', (e) => { if (e.target === historyModal) closeHistoryModal(); });

                // Setup Drag and Drop for the unified board
                Object.entries(taskColumns).forEach(([status, column]) => {
                    if(!column) return;
                    column.addEventListener('dragover', e => { e.preventDefault(); const afterElement = getDragAfterElement(column, e.clientY); const dragging = document.querySelector('.dragging'); if(dragging) { if (afterElement == null) { column.appendChild(dragging); } else { column.insertBefore(dragging, afterElement); } } });
                    
                    column.addEventListener('drop', e => {
                        e.preventDefault();
                        const reorderedTasks = [];
                        const statusMap = {
                            'todo-column': 'todo',
                            'inprogress-column': 'inprogress',
                            'done-column': 'done'
                        };

                        Object.entries(taskColumns).forEach(([statusKey, colEl]) => {
                            const tasksInColumn = colEl.querySelectorAll('.task');
                            tasksInColumn.forEach(taskEl => {
                                const taskId = taskEl.dataset.id;
                                const task = data.tasks.find(t => t.id === taskId) || data.tasksArchive.find(t => t.id === taskId);
                                if (task) {
                                    const newStatus = statusMap[colEl.id];
                                    const oldStatus = task.status;

                                    if (newStatus !== oldStatus) {
                                        task.status = newStatus;
                                        if (newStatus === 'done' && oldStatus !== 'done') {
                                            task.completedDate = new Date().toISOString();
                                            if (task.type === 'learning') updateStudyStreak();
                                        } else if (newStatus !== 'done' && oldStatus === 'done') {
                                            task.completedDate = null; 
                                        }
                                    }
                                    reorderedTasks.push(task);
                                }
                            });
                        });
                        
                        // Also include tasks that might be in the archive but were somehow dragged back
                        data.tasksArchive.forEach(archivedTask => {
                            if (!reorderedTasks.find(t => t.id === archivedTask.id)) {
                                reorderedTasks.push(archivedTask);
                            }
                        });


                        data.tasks = reorderedTasks.filter(t => t.status !== 'done' || (t.status === 'done' && t.completedDate.split('T')[0] === getTodayDateString()));
                        data.tasksArchive = reorderedTasks.filter(t => t.status === 'done' && t.completedDate.split('T')[0] !== getTodayDateString());

                        saveData();
                        renderTasks(); 
                        renderWeeklyReview();
                    });
                });
            };

            initDashboard();

            // --- PUBLIC PROJECTS LOGIC (No changes) ---
            const apps = [
               { name: "JLPT N5 Kotoba (Vocabulary)", description: "A focused study tool for mastering the essential vocabulary required for the Japanese Language Proficiency Test N5 level.", demoUrl: "https://kh125.github.io/jlpt-n5-kotoba/", repoUrl: "https://github.com/kh125/jlpt-n5-kotoba", icon: "book-open" },
               { name: "Kanji Flashcards & Practice", description: "A dedicated application for practicing and learning fundamental Kanji characters. Essential for N5 and beyond.", demoUrl: "https://kh125.github.io/kanji/", repoUrl: "https://github.com/kh125/kanji", icon: "type" }
            ];

            function renderAppCards(apps) {
                const appList = document.getElementById('app-list');
                if(!appList) return;
                appList.innerHTML = ''; 
                if (!apps || apps.length === 0) { appList.innerHTML = '<p class="col-span-full text-center text-gray-500 py-12">No applications found.</p>'; return; }
                apps.forEach(app => {
                    const card = document.createElement('div');
                    card.className = "bg-[#161b22] p-6 rounded-xl border border-gray-700 shadow-lg transform transition duration-300 hover:scale-[1.02] hover:shadow-2xl";
                    card.innerHTML = `
                        <div class="flex items-center mb-4">
                            <i data-lucide="${app.icon}" class="icon text-indigo-400"></i>
                            <h3 class="text-2xl font-semibold text-gray-200">${app.name}</h3>
                        </div>
                        <p class="text-gray-400 mb-6 text-sm min-h-[50px]">${app.description}</p>
                        <div class="flex space-x-4">
                            <a href="${app.demoUrl}" target="_blank" rel="noopener noreferrer" class="flex-1 text-center py-2 px-4 rounded-lg font-medium text-white bg-indigo-600 hover:bg-indigo-500 transition duration-150 shadow-md shadow-indigo-500/50 flex items-center justify-center text-sm sm:text-base whitespace-nowrap">
                                <i data-lucide="play" class="icon w-4 h-4 mr-2"></i>Live Demo
                            </a>
                            <a href="${app.repoUrl}" target="_blank" rel="noopener noreferrer" class="flex-1 text-center py-2 px-4 rounded-lg font-medium text-indigo-400 border border-gray-600 hover:bg-gray-800 transition duration-150 flex items-center justify-center text-sm sm:text-base whitespace-nowrap">
                                <i data-lucide="github" class="icon w-4 h-4 mr-2"></i>Source
                            </a>
                        </div>`;
                    appList.appendChild(card);
                });
                if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            }
            renderAppCards(apps);
            
        });
    </script>
</body>
</html>